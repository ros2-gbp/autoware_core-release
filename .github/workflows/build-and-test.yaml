name: build-and-test

on:
  push:
    branches:
      - main

jobs:
  bnt:
    strategy:
      fail-fast: false
      matrix:
        rosdistro: [humble, jazzy]
        above: [false, true]
        include:
          - rosdistro: humble
            container: ghcr.io/autowarefoundation/autoware:core-common-devel

          - rosdistro: jazzy
            container: ghcr.io/autowarefoundation/autoware:core-common-devel-jazzy-amd64

    uses: ./.github/workflows/build-and-test-reusable.yaml

    with:
      rosdistro: ${{ matrix.rosdistro }}
      container: ${{ matrix.container }}
      pull-ccache: false
      push-ccache: true
      cache-key-element: build
      above: ${{ matrix.above }}
      codecov-flag: total-${{ matrix.rosdistro }}
      concurrency-group: build-and-test-${{ matrix.rosdistro }}${{ matrix.above && '-above' || '' }}-${{ github.ref }}-${{ github.run_id }}
      runner: ${{ matrix.above && '["self-hosted","Linux","X64"]' || '["ubuntu-latest"]' }}

    secrets:
      codecov-token: ${{ secrets.CODECOV_TOKEN }}
