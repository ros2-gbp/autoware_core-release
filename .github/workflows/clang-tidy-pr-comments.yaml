# This file is automatically synced from:
# https://github.com/autowarefoundation/sync-file-templates
# To make changes, update the source repository and follow the guidelines in its README.

name: clang-tidy-pr-comments

on:
  workflow_run:
    workflows:
      - build-and-test-differential
    types:
      - completed

jobs:
  clang-tidy-pr-comments:
    if: ${{ github.event.workflow_run.event == 'pull_request' && contains(fromJson('["success", "failure"]'), github.event.workflow_run.conclusion) }}
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download analysis results
        run: |
          gh run download ${{ github.event.workflow_run.id }} -D /tmp || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find clang-tidy-result artifact directory
        id: find-artifact-dir
        run: |
          artifact_dir=""
          # Prefer jazzy over humble (newer distro)
          if [ -f "/tmp/clang-tidy-result-jazzy/fixes.yaml" ]; then
            artifact_dir="/tmp/clang-tidy-result-jazzy"
          elif [ -f "/tmp/clang-tidy-result-humble/fixes.yaml" ]; then
            artifact_dir="/tmp/clang-tidy-result-humble"
          # Fallback to default name for backward compatibility
          elif [ -f "/tmp/clang-tidy-result/fixes.yaml" ]; then
            artifact_dir="/tmp/clang-tidy-result"
          fi
          if [ -n "$artifact_dir" ]; then
            echo "artifact-dir=$artifact_dir" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if the fixes.yaml file exists
        id: check-fixes-yaml-existence
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        uses: autowarefoundation/autoware-github-actions/check-file-existence@v1
        with:
          files: ${{ steps.find-artifact-dir.outputs.artifact-dir }}/fixes.yaml

      - name: Set variables
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        id: set-variables
        run: |
          artifact_dir="${{ steps.find-artifact-dir.outputs.artifact-dir }}"
          echo "pr-id=$(cat $artifact_dir/pr-id.txt)" >> $GITHUB_OUTPUT
          echo "pr-head-repo=$(cat $artifact_dir/pr-head-repo.txt)" >> $GITHUB_OUTPUT
          echo "pr-head-ref=$(cat $artifact_dir/pr-head-ref.txt)" >> $GITHUB_OUTPUT

      - name: Check out PR head
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.set-variables.outputs.pr-head-repo }}
          ref: ${{ steps.set-variables.outputs.pr-head-ref }}
          persist-credentials: false

      - name: Replace paths in fixes.yaml
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        run: |
          artifact_dir="${{ steps.find-artifact-dir.outputs.artifact-dir }}"
          sed -i -e "s|/__w/|/home/runner/work/|g" $artifact_dir/fixes.yaml
          cat $artifact_dir/fixes.yaml

      - name: Copy fixes.yaml to access from Docker Container Action
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        run: |
          artifact_dir="${{ steps.find-artifact-dir.outputs.artifact-dir }}"
          cp $artifact_dir/fixes.yaml fixes.yaml

      - name: Run clang-tidy-pr-comments action
        if: ${{ steps.find-artifact-dir.outputs.exists == 'true' }}
        uses: platisd/clang-tidy-pr-comments@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          clang_tidy_fixes: fixes.yaml
          pull_request_id: ${{ steps.set-variables.outputs.pr-id }}
